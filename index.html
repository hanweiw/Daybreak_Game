<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ´æ™“è¡ŒåŠ¨ v7.2 | ç¨³å®šä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --dark: #1e293b; --gray: #94a3b8; --bg: #f1f5f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; overflow-y: auto; }
        .hidden { display: none !important; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 15px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; outline: none; }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        input, select, textarea { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }

        /* --- ç™»å½• --- */
        #screen-login { max-width: 400px; margin: 80px auto; border-top: 5px solid var(--primary); }
        .login-nav { display: flex; margin-bottom: 15px; background: #e2e8f0; border-radius: 6px; padding: 4px; }
        .login-nav button { flex: 1; padding: 8px; background: none; color: #475569; }
        .login-nav button.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- æ•™å¸ˆç«¯ --- */
        .tea-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-left: 6px solid var(--dark); }
        #screen-teacher-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 12px; align-items: start; }
        .left-panel { display: flex; flex-direction: column; gap: 12px; }
        .right-panel { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        .doom-bar-container { background: #fee2e2; border-radius: 8px; padding: 10px; border: 1px solid #fca5a5; }
        .doom-bar { height: 12px; background: #e74c3c; border-radius: 6px; width: 0%; transition: 0.5s; }
        
        .stat-grid-small { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .stat-box-small { background: var(--dark); color: white; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-box-small h4 { margin: 0; font-size: 11px; font-weight: normal; color: #94a3b8; }
        .stat-box-small p { margin: 4px 0 0; font-size: 18px; font-weight: bold; }
        .stat-danger { background: #7f1d1d; } 

        .chart-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .chart-box { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        .chart-box h4 { margin: 0 0 5px 0; font-size: 12px; color: #475569; text-align: center; }
        .chart-container { height: 140px; position: relative; } 
        .pie-container { height: 160px; position: relative; }

        .team-compact { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; margin-bottom: 8px; transition: 0.2s; }
        .team-compact.dead { background: #fef2f2; border-color: #fecaca; opacity: 0.6; }
        .team-compact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .team-compact-stats { display: flex; justify-content: space-between; font-size: 11px; color: #334155; }
        .status-A { color: #d97706; background: #fef3c7; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-B { color: #b91c1c; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-C { color: #15803d; background: #dcfce3; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        #screen-student { max-width: 600px; margin: 0 auto; }
        .ap-circle { width: 90px; height: 90px; border-radius: 50%; border: 6px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 15px; background: white; }
    </style>
</head>
<body>

    <div id="screen-login" class="card">
        <h2 style="text-align:center; margin-top:0;">ğŸ›¡ï¸ ç ´æ™“è¡ŒåŠ¨ç³»ç»Ÿ</h2>
        <div class="login-nav">
            <button id="tab-stu" class="active" onclick="toggleLoginRole('student')">å­¦ç”Ÿå…¥å£</button>
            <button id="tab-tea" onclick="toggleLoginRole('teacher')">æŒ‡æŒ¥å…¥å£</button>
        </div>
        <div id="form-student">
            <input type="text" id="stu-user" placeholder="è¾“å…¥åˆ†é…çš„è´¦å· (å¦‚: 100101)">
            <input type="password" id="stu-pass" placeholder="è¾“å…¥éšæœºå¯†ç  (ä¸åˆ†å¤§å°å†™)">
            <button id="btn-login-stu" onclick="studentLogin()" style="background: var(--primary); color: white; width: 100%; padding: 12px; margin-top:10px;">è¿æ¥å…¨çƒç½‘ç»œ</button>
        </div>
        <div id="form-teacher" class="hidden">
            <select id="tea-room">
                <option value="1001">æˆ¿é—´ 1001</option><option value="1002">æˆ¿é—´ 1002</option>
                <option value="1003">æˆ¿é—´ 1003</option><option value="1004">æˆ¿é—´ 1004</option>
            </select>
            <button onclick="teacherLoginVerify()" style="background: var(--dark); color: white; width: 100%; padding: 12px; margin-top:10px;">è¿›å…¥ä¸Šå¸è§†è§’</button>
        </div>
    </div>

    <div id="screen-teacher" class="hidden">
        <div class="tea-header">
            <h3 style="margin:0;">ğŸŒ å…¨çƒæŒ‡æŒ¥ä¸­å¿ƒ <span id="tag-room" style="color:var(--primary); margin-left:10px; font-size:15px;"></span></h3>
            <div style="display:flex; gap:10px;">
                <button onclick="exportCSV()" style="background:var(--success); color:white; padding:6px 15px; font-size:12px;">ğŸ“¥ å¯¼å‡ºå«åå•CSV</button>
                <button onclick="resetGame()" style="background:#b91c1c; color:white; padding:6px 15px; font-size:12px;">ğŸ”„ å¼€å¯æ–°åœºæ¬¡</button>
                <button onclick="logout()" style="background:var(--gray); color:white; padding:6px 15px; font-size:12px;">ç™»å‡º</button>
            </div>
        </div>

        <div id="screen-teacher-layout">
            <div class="left-panel">
                <div class="doom-bar-container">
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold; color:#991b1b; margin-bottom:5px;">
                        <span>âš ï¸ äººç±»ç­ç»é¢„è­¦çº¿ (æ­»äº¡è¶…20%å³è´¥)</span>
                        <span id="doom-percent">0.0%</span>
                    </div>
                    <div style="background:white; border-radius:6px; overflow:hidden;"><div id="doom-bar" class="doom-bar"></div></div>
                </div>

                <div class="stat-grid-small">
                    <div class="stat-box-small"><h4>å®éªŒåœºæ¬¡</h4><p id="t-exp">1</p></div>
                    <div class="stat-box-small"><h4>å½“å‰è½®æ•°</h4><p id="t-turn">1</p></div>
                    <div class="stat-box-small"><h4>ç°å­˜æ€»äººå£</h4><p id="t-pop" style="color:#60a5fa;">0</p></div>
                    <div class="stat-box-small stat-danger"><h4>ç´¯è®¡æ­»äº¡äººæ•°</h4><p id="t-dead" style="color:#fca5a5;">0</p></div>
                    <div class="stat-box-small" style="background:#064e3b;"><h4>è§£è¯è¿›åº¦</h4><p id="t-cure" style="color:#69f0ae;">0%</p></div>
                </div>

                <div class="card" style="margin-bottom:0; padding:12px; display:flex; gap:12px; background:#f8fafc; border:1px solid #e2e8f0;">
                    <button onclick="assignRoles()" style="background:var(--primary); color:white; flex:1; padding:10px; font-size:15px;">ğŸ² 1. åŠ¨æ€åˆ†é…å±æ€§ (A/B/C)</button>
                    <button id="btn-next-turn" onclick="nextTurn()" style="background:var(--danger); color:white; flex:1; padding:10px; font-size:15px; box-shadow: 0 4px 10px rgba(231,76,60,0.3);">âš ï¸ 2. ç»“ç®—å¹¶ç”Ÿæˆæœ¬è½®æˆ˜æŠ¥</button>
                </div>

                <div class="chart-grid-3">
                    <div class="chart-box"><h4>ğŸ“‰ ç°å­˜æ„ŸæŸ“è¶‹åŠ¿</h4><div class="chart-container"><canvas id="chart-inf"></canvas></div></div>
                    <div class="chart-box"><h4>ğŸ’€ ç´¯è®¡æ­»äº¡æ”€å‡</h4><div class="chart-container"><canvas id="chart-dead"></canvas></div></div>
                    <div class="chart-box"><h4>ğŸ§ª ç–«è‹—ç ”å‘è¿›åº¦</h4><div class="chart-container"><canvas id="chart-cure"></canvas></div></div>
                </div>

                <div class="card" style="margin-bottom:0; padding:10px;">
                    <h4 style="margin:0 0 10px 0; text-align:center; color:#475569; border-bottom:1px dashed #cbd5e1; padding-bottom:5px;">ğŸ“Š ä¸Šä¸€è½®å„ç»„çœŸå®æŠ•å…¥ç‚¹æ•°å æ¯” (è¡Œä¸ºåæ€)</h4>
                    <div class="chart-grid-3">
                        <div class="pie-container"><canvas id="chart-pie-p"></canvas></div>
                        <div class="pie-container"><canvas id="chart-pie-r"></canvas></div>
                        <div class="pie-container"><canvas id="chart-pie-s"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #f1f5f9; padding-bottom:8px; margin-bottom:12px;">
                    <h4 style="margin:0; font-size:14px;">å„å›½å®æ—¶çŠ¶æ€</h4>
                    <span style="background:#e2e8f0; font-size:11px; padding:2px 6px; border-radius:10px; font-weight:bold;"><span id="t-online" style="color:var(--success);">0</span> åœ¨çº¿</span>
                </div>
                <div id="team-list"></div>
            </div>
        </div>
    </div>

    <div id="screen-student" class="hidden">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="s-team-display" style="margin:0; font-size:22px;">è½½å…¥ä¸­...</h2>
            <button onclick="logout()" style="background:var(--gray); color:white; padding:6px 15px; font-size:12px;">æ–­å¼€è¿æ¥</button>
        </div>

        <div class="card" style="border-left: 4px solid var(--primary);">
            <details>
                <summary style="cursor:pointer; font-weight:bold; color:var(--primary);">âœï¸ ç™»è®°å›½å®¶ä¸æˆå‘˜èµ„æ–™</summary>
                <div style="margin-top:10px;">
                    <input type="text" id="edit-name" placeholder="å›½å®¶åç§°">
                    <textarea id="edit-members" placeholder="ç»„å‘˜å§“åä¸å­¦å·" rows="2"></textarea>
                    <button onclick="updateTeamInfo()" style="background:var(--primary); color:white; padding:8px 20px;">ğŸ’¾ ä¿å­˜</button>
                </div>
            </details>
        </div>

        <div class="card" style="text-align:center; background:#f8fafc;">
            <span id="s-type-tag" style="font-weight:bold; font-size:14px;">ç­‰å¾…åˆ†é…...</span>
            <div class="ap-circle" style="margin-top:20px;">
                <span style="font-size:12px; color:#64748b;">å¯ç”¨ AP</span>
                <span id="s-ap" style="font-size:36px; font-weight:bold; color:var(--dark);">0</span>
            </div>
            <p style="margin:0; font-size:15px;">æ”¿åºœæƒå¨å€¼: <b id="s-auth" style="color:var(--danger); font-size:22px;">0</b> / 100</p>
        </div>

        <div id="input-area" class="card">
            <h4 style="margin-top:0; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">ğŸ“ è¡ŒåŠ¨æŒ‡ä»¤ä¸‹è¾¾</h4>
            <div style="display:grid; grid-template-columns: auto 1fr; gap:12px; align-items:center;">
                <label>ğŸ›¡ï¸ é˜²æ§ (å‹åˆ¶R0)</label><input type="number" id="in-p" value="0" min="0" oninput="calcAP()">
                <label>ğŸ§ª ç ”å‘ (æ¨è¿›è§£è¯)</label><input type="number" id="in-r" value="0" min="0" oninput="calcAP()">
                <label>ğŸ“¢ ç»´ç¨³ (æ¢å¤æƒå¨)</label><input type="number" id="in-s" value="0" min="0" oninput="calcAP()">
            </div>
            <div style="margin-top:15px; background:#e2e8f0; padding:12px; border-radius:6px; font-weight:bold; font-size:14px;">
                æ€»æŠ•å…¥: <span id="s-spent">0</span> / <span id="s-max">0</span>
                <span id="s-status" style="float:right; color:var(--success)"></span>
            </div>
            <button id="btn-submit" onclick="submitDecision()" style="background:var(--primary); color:white; width:100%; padding:15px; margin-top:15px; font-size:16px;">ğŸš€ é”å®šæäº¤</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myTeamId = null, currentRoomId = null, myMaxAP = 10;
    let chartInf = null, chartCure = null, chartDead = null;
    let chartPieP = null, chartPieR = null, chartPieS = null;
    let globalActiveTeams = 10;

    function toggleLoginRole(role) {
        document.getElementById('form-student').classList.toggle('hidden', role !== 'student');
        document.getElementById('form-teacher').classList.toggle('hidden', role !== 'teacher');
        document.getElementById('tab-stu').classList.toggle('active', role === 'student');
        document.getElementById('tab-tea').classList.toggle('active', role === 'teacher');
    }

    // æ ¸å¿ƒä¿®å¤ç‚¹ï¼šç²¾ç¡®éšè—ç‰¹å®šçš„å±‚ï¼Œé˜²æ­¢è¯¯ä¼¤ card
    function navigateTo(screen) {
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-teacher').classList.add('hidden');
        document.getElementById('screen-student').classList.add('hidden');
        document.getElementById(screen).classList.remove('hidden');
    }

    window.onload = async () => {
        const tid = localStorage.getItem('bod_team_id'), rid = localStorage.getItem('bod_room_id'), teaRoom = localStorage.getItem('bod_tea_room');
        if (tid && rid) {
            const { data } = await supabaseClient.from('teams').select('*').eq('id', tid).single();
            if(data) { myTeamId = tid; currentRoomId = rid; initStudentUI(data); return; }
        }
        if (teaRoom) { currentRoomId = teaRoom; initTeacherUI(); }
    };

    function logout() { if(confirm("ç¡®å®šé€€å‡ºï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    async function studentLogin() {
        const btn = document.getElementById('btn-login-stu');
        btn.innerText = "â³ éªŒè¯ä¸­...";
        
        const u = document.getElementById('stu-user').value.trim();
        const p = document.getElementById('stu-pass').value.trim().toLowerCase();
        
        try {
            const { data, error } = await supabaseClient.from('teams').select('*').eq('username', u).eq('password', p).single();
            if (error || !data) {
                btn.innerText = "è¿æ¥å…¨çƒç½‘ç»œ";
                return alert("è´¦å·æˆ–å¯†ç é”™è¯¯ï¼(æç¤ºï¼šæ³¨æ„æ£€æŸ¥å‰åç©ºæ ¼)");
            }
            myTeamId = data.id; currentRoomId = data.room_id;
            localStorage.setItem('bod_team_id', myTeamId); localStorage.setItem('bod_room_id', currentRoomId);
            await supabaseClient.from('teams').update({ is_active: true }).eq('id', myTeamId);
            initStudentUI(data);
        } catch (e) {
            alert("ç½‘ç»œè¿æ¥å¼‚å¸¸");
        }
        btn.innerText = "è¿æ¥å…¨çƒç½‘ç»œ";
    }

    function teacherLoginVerify() {
        const room = document.getElementById('tea-room').value;
        const pwd = prompt("è¾“å…¥æˆ¿é—´ç®¡ç†å¯†ç :");
        if (pwd === room + "419") { currentRoomId = room; localStorage.setItem('bod_tea_room', room); initTeacherUI(); }
    }

    async function initTeacherUI() {
        navigateTo('screen-teacher');
        document.getElementById('tag-room').innerText = `[æˆ¿é—´ ${currentRoomId}]`;
        initCharts(); subscribeToGame(); fetchTeamList(); 
        const { data } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
        updateTeacherStats(data); fetchHistoryAndDraw();
        
        const savedPies = localStorage.getItem(`pies_${currentRoomId}`);
        if(savedPies) drawPies(JSON.parse(savedPies));
    }

    function initStudentUI(teamData) {
        navigateTo('screen-student');
        document.getElementById('s-team-display').innerText = teamData.name;
        document.getElementById('edit-name').value = teamData.name;
        document.getElementById('edit-members').value = teamData.members;
        updateStudentUI(teamData); subscribeToGame();
    }

    async function nextTurn() {
        if(!confirm("ç¡®å®šç»“ç®—å¹¶æå–å„ç»„æ•°æ®ç”Ÿæˆæˆ˜æŠ¥ï¼Ÿ")) return;
        const btn = document.getElementById('btn-next-turn');
        btn.disabled = true; btn.innerText = "â³ æ¼”ç®—ä¸­...";

        try {
            const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
            const { data: room } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
            
            let N = teams.length || 1;
            let sumP = 0, sumR = 0, coll = 0;
            
            let pieLabels = [], pieP = [], pieR = [], pieS = [];
            
            for (let t of teams) {
                const d = t.last_decision || {p:0, r:0, s:0};
                
                pieLabels.push(t.name.substring(0,6)); 
                pieP.push(d.p); pieR.push(d.r); pieS.push(d.s);

                if (t.authority > 0) {
                    sumP += d.p * (t.country_type==='B'?1.5:1);
                    sumR += d.r * (t.country_type==='A'?2.0:1);
                } else coll++;
                
                let nAuth = Math.max(0, Math.min(100, t.authority - (5 + d.p*1.2)*(t.country_type==='A'?1.3:1) + d.s*3));
                let bAP = (t.country_type==='A')?15:(t.country_type==='B'?12:8);
                await supabaseClient.from('teams').update({ authority: nAuth, last_decision: null, ap_count: bAP }).eq('id', t.id);
            }
            
            const pieData = { labels: pieLabels, p: pieP, r: pieR, s: pieS };
            localStorage.setItem(`pies_${currentRoomId}`, JSON.stringify(pieData));
            drawPies(pieData);

            let nR0 = Math.max(0.5, room.infection_rate - (sumP/(N*2.5)*0.1) + coll*0.05);
            let nCure = Math.min(100, room.cure_progress + (sumR/(N*1.0)));
            let newDeaths = Math.floor(room.infection_total * 0.10);
            let nDeadTotal = (room.dead_total || 0) + newDeaths;
            let nInf = Math.floor((room.infection_total - newDeaths) * nR0);
            if(nInf < 0) nInf = 0;

            await supabaseClient.from('game_logs').insert([{ 
                room_id: currentRoomId, exp_id: room.experiment_id, turn: room.turn, 
                infection_total: nInf, infection_rate: nR0, cure_progress: nCure, dead_total: nDeadTotal
            }]);
            
            await supabaseClient.from('game_rooms').update({ 
                turn: room.turn+1, infection_total: nInf, infection_rate: nR0, cure_progress: nCure, dead_total: nDeadTotal
            }).eq('id', currentRoomId);

            setTimeout(() => {
                let maxPop = N * 1000000000;
                if(nCure >= 100) alert("ğŸ‰ èƒœåˆ©ï¼è§£è¯ç ”å‘æˆåŠŸï¼Œäººç±»åº¦è¿‡å±æœºï¼");
                else if(coll === N) alert("ğŸ’€ å¤±è´¥ï¼æ‰€æœ‰å›½å®¶æ”¿åºœç˜«ç—ªï¼Œäººç±»æ–‡æ˜å´©æºƒï¼");
                else if(nDeadTotal >= maxPop * 0.20) alert("ğŸ’€ å¤±è´¥ï¼æ­»äº¡äººæ•°è¶…è¿‡ 20% è­¦æˆ’çº¿ï¼Œç‰©ç§ç­ç»ï¼");
            }, 1000);

        } catch (e) { alert("ç½‘ç»œå¼‚å¸¸"); console.error(e); } 
        finally { btn.disabled = false; btn.innerText = "âš ï¸ 2. ç»“ç®—å¹¶ç”Ÿæˆæœ¬è½®æˆ˜æŠ¥"; }
    }

    async function resetGame() {
        if(!confirm("âš ï¸ ç¡®å®šé‡ç½®å®éªŒï¼Ÿ\nä¼šæ ¹æ®ç›®å‰åœ¨çº¿ç»„æ•° (N) é‡æ–°ç”Ÿæˆäººå£åŸºæ•°ï¼")) return;
        const { data: teams } = await supabaseClient.from('teams').select('id').eq('room_id', currentRoomId).eq('is_active', true);
        let N = teams.length || 10;
        let initInfect = N * 10000000; 
        const { data: room } = await supabaseClient.from('game_rooms').select('experiment_id').eq('id', currentRoomId).single();
        const nextExpId = (room?.experiment_id || 1) + 1;

        await supabaseClient.from('game_rooms').update({ 
            experiment_id: nextExpId, turn: 1, infection_total: initInfect, dead_total: 0, infection_rate: 1.5, cure_progress: 0 
        }).eq('id', currentRoomId);
        await supabaseClient.from('teams').update({ country_type: 'å¾…å®š', ap_count: 10, authority: 100, last_decision: null }).eq('room_id', currentRoomId);
        
        localStorage.removeItem(`pies_${currentRoomId}`); 
        location.reload();
    }

    function subscribeToGame() {
        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
            if(payload.table === 'teams' && payload.new.room_id == currentRoomId) {
                if(myTeamId) { if(payload.new.id == myTeamId) updateStudentUI(payload.new); }
                else { fetchTeamList(); } 
            }
            if(payload.table === 'game_rooms' && payload.new.id == currentRoomId) {
                if(myTeamId) { 
                    alert("ğŸ”” æŒ‡æŒ¥ä¸­å¿ƒæ—¶é—´æ¨è¿›ï¼ç¬¬ " + payload.new.turn + " è½®æŒ‡ä»¤å¼€å¯ï¼"); 
                    document.getElementById('s-status').innerText = ""; document.getElementById('btn-submit').disabled = false;
                    document.getElementById('in-p').value = 0; document.getElementById('in-r').value = 0; document.getElementById('in-s').value = 0; calcAP();
                } else { 
                    updateTeacherStats(payload.new); fetchHistoryAndDraw(); 
                }
            }
        }).subscribe();
    }

    function initCharts() {
        const lineOpts = { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{ticks:{font:{size:10}}}, y:{ticks:{font:{size:10}}}} };
        chartInf = new Chart(document.getElementById('chart-inf'), { type: 'line', data: { labels: [], datasets: [{ label: 'æ„ŸæŸ“è€…', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.2 }] }, options: lineOpts });
        chartDead = new Chart(document.getElementById('chart-dead'), { type: 'line', data: { labels: [], datasets: [{ label: 'æ­»äº¡', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.2)', fill: true, tension: 0.2 }] }, options: lineOpts });
        chartCure = new Chart(document.getElementById('chart-cure'), { type: 'line', data: { labels: [], datasets: [{ label: 'è§£è¯ %', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.2 }] }, options: {...lineOpts, scales:{y:{min:0, max:100, ticks:{font:{size:10}}}}} });
        
        const pieOpts = (title) => ({ responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {boxWidth: 8, font: {size: 9}} }, title: { display: true, text: title, font: {size: 13}, padding: 4 } } });
        chartPieP = new Chart(document.getElementById('chart-pie-p'), { type: 'pie', data: { labels: [], datasets: [{ data: [] }] }, options: pieOpts('ğŸ›¡ï¸ é˜²æ§è´¡çŒ®åœˆ') });
        chartPieR = new Chart(document.getElementById('chart-pie-r'), { type: 'pie', data: { labels: [], datasets: [{ data: [] }] }, options: pieOpts('ğŸ§ª ç ”å‘è´¡çŒ®åœˆ') });
        chartPieS = new Chart(document.getElementById('chart-pie-s'), { type: 'pie', data: { labels: [], datasets: [{ data: [] }] }, options: pieOpts('ğŸ“¢ ç»´ç¨³è‡ªä¿åœˆ') });
    }

    function drawPies(data) {
        if(!chartPieP || !data) return;
        const bgColors = ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#10b981','#14b8a6','#06b6d4','#0ea5e9','#3b82f6','#6366f1','#8b5cf6','#a855f7','#d946ef','#ec4899'];
        chartPieP.data.labels = data.labels; chartPieP.data.datasets[0] = { data: data.p, backgroundColor: bgColors, borderWidth: 1 }; chartPieP.update();
        chartPieR.data.labels = data.labels; chartPieR.data.datasets[0] = { data: data.r, backgroundColor: bgColors, borderWidth: 1 }; chartPieR.update();
        chartPieS.data.labels = data.labels; chartPieS.data.datasets[0] = { data: data.s, backgroundColor: bgColors, borderWidth: 1 }; chartPieS.update();
    }

    async function fetchHistoryAndDraw() {
        setTimeout(async () => {
            const { data: logs } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('turn');
            const { data: room } = await supabaseClient.from('game_rooms').select('experiment_id').eq('id', currentRoomId).single();
            const cLogs = logs.filter(l => l.exp_id === room.experiment_id);
            
            if(chartInf && cLogs.length > 0) {
                const labels = cLogs.map(l => "R"+l.turn);
                chartInf.data.labels = labels; chartInf.data.datasets[0].data = cLogs.map(l => l.infection_total); chartInf.update();
                chartDead.data.labels = labels; chartDead.data.datasets[0].data = cLogs.map(l => l.dead_total || 0); chartDead.update();
                chartCure.data.labels = labels; chartCure.data.datasets[0].data = cLogs.map(l => l.cure_progress); chartCure.update();
            }
        }, 800);
    }

    async function fetchTeamList() {
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true).order('username');
        globalActiveTeams = teams.length || 1;
        document.getElementById('t-online').innerText = globalActiveTeams;
        
        document.getElementById('team-list').innerHTML = teams.map(t => `
            <div class="team-compact ${t.authority<=0?'dead':''}">
                <div class="team-compact-header">
                    <strong style="font-size:13px;">${t.name}</strong>
                    <span class="status-${t.country_type}">${t.country_type}</span>
                </div>
                <div class="team-compact-stats">
                    <span>AP: <b>${t.ap_count}</b></span> | <span>æƒ: <b style="${t.authority<30?'color:#e74c3c':''}">${Math.floor(t.authority)}</b></span> | 
                    <span style="font-weight:bold; color:${t.last_decision?'#10b981':'#f59e0b'}">${t.last_decision?'âœ… å·²é”å®š':'â³ æ€è€ƒä¸­'}</span>
                </div>
            </div>`).join('');
    }

    function updateTeacherStats(r) {
        document.getElementById('t-exp').innerText = r.experiment_id;
        document.getElementById('t-turn').innerText = r.turn;
        
        let pop = globalActiveTeams * 1000000000;
        let dead = r.dead_total || 0;
        let remainPop = pop - dead;
        let doomPercent = pop > 0 ? (dead / (pop * 0.20)) * 100 : 0;
        if(doomPercent > 100) doomPercent = 100;

        document.getElementById('t-pop').innerText = remainPop.toLocaleString();
        document.getElementById('t-dead').innerText = dead.toLocaleString();
        document.getElementById('t-cure').innerText = r.cure_progress.toFixed(1) + '%';
        
        document.getElementById('doom-bar').style.width = doomPercent + '%';
        document.getElementById('doom-percent').innerText = (dead/pop*100).toFixed(2) + '% / 20.0%';
    }

    function updateStudentUI(t) {
        myMaxAP = t.ap_count;
        document.getElementById('s-ap').innerText = t.ap_count;
        document.getElementById('s-max').innerText = t.ap_count;
        document.getElementById('s-auth').innerText = Math.floor(t.authority);
        document.getElementById('s-type-tag').innerText = t.country_type === 'å¾…å®š' ? "ç­‰å¾…åˆ†é…..." : "å±æ€§: " + t.country_type + " å‹";
        document.getElementById('s-type-tag').className = "status-" + t.country_type;
    }

    function calcAP() {
        const p = parseInt(document.getElementById('in-p').value)||0, r = parseInt(document.getElementById('in-r').value)||0, s = parseInt(document.getElementById('in-s').value)||0;
        const t = p + r + s;
        document.getElementById('s-spent').innerText = t; document.getElementById('s-spent').style.color = t > myMaxAP ? 'red' : 'black';
        document.getElementById('btn-submit').disabled = t > myMaxAP;
    }

    async function submitDecision() {
        const p = parseInt(document.getElementById('in-p').value)||0, r = parseInt(document.getElementById('in-r').value)||0, s = parseInt(document.getElementById('in-s').value)||0;
        await supabaseClient.from('teams').update({ last_decision: {p, r, s} }).eq('id', myTeamId);
        document.getElementById('s-status').innerText = "âœ… é”å®š"; document.getElementById('btn-submit').disabled = true;
    }

    async function updateTeamInfo() {
        const name = document.getElementById('edit-name').value, members = document.getElementById('edit-members').value;
        await supabaseClient.from('teams').update({ name, members }).eq('id', myTeamId);
        document.getElementById('s-team-display').innerText = name; alert("èµ„æ–™å·²ä¿å­˜ï¼");
    }

    async function assignRoles() {
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
        const p = ['A', 'B', 'B', 'C', 'C'];
        for (let i = 0; i < teams.length; i++) {
            let type = p[i % p.length], ap = (type==='A'?15:(type==='B'?12:8));
            await supabaseClient.from('teams').update({ country_type: type, ap_count: ap, authority: 100 }).eq('id', teams[i].id);
        }
        alert("åŠ¨æ€å±æ€§åˆ†é…å®Œæˆï¼");
    }

    async function exportCSV() {
        const { data: logs } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('created_at', { ascending: true });
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
        if(!logs.length) return alert("å½“å‰æ— æ•°æ®ï¼");
        
        let csv = "\uFEFFã€ç¬¬ä¸€éƒ¨åˆ†ï¼šå®è§‚å®éªŒè¿‡ç¨‹æ•°æ®ã€‘\nå®éªŒåœºæ¬¡,è½®æ•°,ç°å­˜æ„ŸæŸ“æ•°,R0,è§£è¯è¿›åº¦,ç´¯è®¡æ­»äº¡äººæ•°,è®°å½•æ—¶é—´\n";
        logs.forEach(l => { csv += `${l.exp_id},${l.turn},${l.infection_total},${l.infection_rate.toFixed(2)},${l.cure_progress.toFixed(2)}%,${l.dead_total || 0},${l.created_at}\n`; });
        csv += "\n\nã€ç¬¬äºŒéƒ¨åˆ†ï¼šå„å°ç»„æ³¨å†Œä¸æˆå‘˜åå•ã€‘\nç³»ç»Ÿè´¦å·,å°ç»„å›½å®¶å,å›½å®¶å±æ€§,ç»„å‘˜ä¿¡æ¯\n";
        teams.forEach(t => { csv += `${t.username},${t.name},${t.country_type},${t.members ? t.members.replace(/\n/g, " | ") : "æœªå¡«å†™"}\n`; });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Daybreak_ExpData_Room${currentRoomId}.csv`;
        link.click();
    }
</script>
</body>
</html>
