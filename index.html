<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ´æ™“è¡ŒåŠ¨ï¼šæœ€åé˜²çº¿ (v6.0 å®ååˆ¶éƒ¨ç½²ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 25px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { margin-top: 0; color: #2c3e50; font-size: 24px; }
        .hidden { display: none !important; }
        
        input, select, button, textarea { padding: 12px; margin: 8px 0; font-size: 16px; border-radius: 8px; border: 1px solid #dfe6e9; width: 100%; box-sizing: border-box; outline: none; transition: all 0.2s; }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        input:focus, textarea:focus { border-color: #3498db; box-shadow: 0 0 5px rgba(52,152,219,0.3); }
        
        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; }
        button:hover { background-color: #2980b9; transform: translateY(-1px); }
        button:disabled { background-color: #b2bec3; cursor: not-allowed; }
        
        .stat-box { display: flex; justify-content: space-around; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(44,62,80,0.3); }
        .stat-item { text-align: center; }
        .stat-item h3 { margin: 0; color: #ecf0f1; font-size: 13px; font-weight: normal; opacity: 0.8; }
        .stat-item p { margin: 5px 0 0; font-size: 26px; font-weight: bold; }
        
        .status-A { color: #e67e22; font-weight: bold; background: #fff3cd; padding: 2px 6px; border-radius: 4px; } 
        .status-B { color: #c0392b; font-weight: bold; background: #f8d7da; padding: 2px 6px; border-radius: 4px; } 
        .status-C { color: #27ae60; font-weight: bold; background: #d4edda; padding: 2px 6px; border-radius: 4px; } 

        .monitor-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f1f1; align-items: center; }
        .dead { text-decoration: line-through; color: #95a5a6; background-color: #f1f2f6; }
        .active-badge { background: #2ecc71; color: white; padding: 2px 4px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
        
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 20px; }
        .flash-green { animation: flashGreen 1s ease-out; }
        @keyframes flashGreen { 0% { background-color: #2ecc71; color: white; } 100% { background-color: transparent; } }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h1>ğŸ¦  ç ´æ™“è¡ŒåŠ¨ï¼šèº«ä»½éªŒè¯</h1>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex:1; min-width: 250px; border-right: 1px dashed #ccc; padding-right: 20px;">
                <h3 style="color: #2c3e50;">æˆ‘æ˜¯è€å¸ˆ</h3>
                <select id="teacher-room-select">
                    <option value="1001">æˆ¿é—´ 1001</option>
                    <option value="1002">æˆ¿é—´ 1002</option>
                    <option value="1003">æˆ¿é—´ 1003</option>
                    <option value="1004">æˆ¿é—´ 1004</option>
                </select>
                <button onclick="checkTeacherPassword()" style="background-color: #2c3e50;">è¿›å…¥æ§åˆ¶å°</button>
            </div>
            <div style="flex:1; min-width: 250px;">
                <h3 style="color: #27ae60;">æˆ‘æ˜¯å­¦ç”Ÿ</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">è¯·è¾“å…¥åˆ†é…çš„è´¦å·å¯†ç  (å¦‚: 100101)</p>
                <input type="text" id="login-user" placeholder="è´¦å·">
                <input type="password" id="login-pass" placeholder="å¯†ç ">
                <button onclick="studentLogin()" style="background-color: #27ae60;">ç™»å½•ç³»ç»Ÿ</button>
            </div>
        </div>
    </div>

    <div id="teacher-dashboard" class="card hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>ğŸŒ å…¨çƒæ€åŠ¿ç›‘æ§ <span id="current-room-display" style="font-size: 16px; color: #e67e22; background: #fff3cd; padding: 2px 8px; border-radius: 4px;"></span></h1>
            <button onclick="resetGame()" style="background-color: #c0392b; width: auto; padding: 8px 15px; font-size: 14px;">ğŸ’¥ é‡ç½®æœ¬æˆ¿é—´</button>
        </div>
        <div class="stat-box">
            <div class="stat-item"><h3>å½“å‰è½®æ•°</h3><p id="t-turn">1</p></div>
            <div class="stat-item"><h3>å…¨çƒæ„ŸæŸ“</h3><p id="t-infection" style="color: #ff7675;">1000</p></div>
            <div class="stat-item"><h3>ä¼ æŸ“ç‡ R0</h3><p id="t-r0">1.50</p></div>
            <div class="stat-item"><h3>åœ¨çº¿ç»„æ•°</h3><p id="t-online-count" style="color: #55efc4;">0 / 15</p></div>
        </div>
        <div class="chart-container"><canvas id="infectionChart"></canvas></div>
        <div style="background: #fff; border: 2px solid #f1f2f6; padding: 20px; border-radius: 12px; margin-top: 25px;">
            <h3>ğŸ® æ¸¸æˆæµç¨‹æ§åˆ¶</h3>
            <div style="display: flex; gap: 15px;">
                <button onclick="assignRoles()" style="flex:1; background-color: #e67e22;">ğŸ² 1. åŠ¨æ€åˆ†é…å±æ€§ (ä»…åœ¨çº¿é˜Ÿä¼)</button>
                <button onclick="nextTurn()" style="flex:1; background-color: #d63031; font-size: 18px;">âš ï¸ 2. ç»“ç®—æœ¬è½®</button>
            </div>
        </div>
        <h3>å„å›½çŠ¶æ€ç›‘æ§ï¼š</h3>
        <div id="team-list">åŠ è½½ä¸­...</div>
    </div>

    <div id="student-dashboard" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 id="s-display-name">åŠ è½½ä¸­...</h1>
            <div>
                 <span id="aid-badge" class="hidden" style="background: #f1c40f; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">æ”¶åˆ°æ´åŠ©!</span>
                 <button onclick="logout()" style="background-color: #95a5a6; font-size: 12px; padding: 5px 10px; width: auto;">ç™»å‡º</button>
            </div>
        </div>
        <div style="background: #eef2f7; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #d1d8e0;">
            <details>
                <summary style="cursor: pointer; font-weight: bold; color: #2980b9;">ğŸ“ ç‚¹å‡»ä¿®æ”¹ï¼šå›½å®¶åç§° & ç»„å‘˜åå•</summary>
                <div style="margin-top: 10px;">
                    <label>å›½å®¶åç§°:</label>
                    <input type="text" id="edit-name" placeholder="èµ·ä¸ªå“äº®çš„åå­—">
                    <label>ç»„å‘˜åå• (å§“å+å­¦å·):</label>
                    <textarea id="edit-members" placeholder="å¼ ä¸‰ 2023001..."></textarea>
                    <button onclick="updateTeamInfo()" style="background-color: #2980b9;">ğŸ’¾ ä¿å­˜ä¿¡æ¯</button>
                </div>
            </details>
        </div>
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 5px solid #3498db;">
            <p style="margin:0; font-weight: bold;">å›½å®¶å±æ€§: <span id="s-country-type">ç­‰å¾…åˆ†é…...</span></p>
            <p style="margin:5px 0 0 0; font-size: 13px; color: #555;" id="s-buff-desc"></p>
        </div>
        <div class="stat-box">
            <div class="stat-item"><h3>å¯ç”¨ AP</h3><p id="s-ap">10</p></div>
            <div class="stat-item"><h3>æœ¬å›½æƒå¨å€¼</h3><p id="s-auth">100</p></div>
        </div>
        <div id="input-area">
            <h3>ğŸ“ æœ¬è½®å†³ç­– (æ€»æŠ•å…¥ â‰¤ AP)</h3>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px;">
                <label>ğŸ›¡ï¸ <b>é˜²æ§æŠ•å…¥</b></label><input type="number" id="input-prevention" value="0" min="0" oninput="updateAPCalc()">
                <label>ğŸ§ª <b>ç ”å‘æŠ•å…¥</b></label><input type="number" id="input-research" value="0" min="0" oninput="updateAPCalc()">
                <label>ğŸ“¢ <b>ç»´ç¨³æŠ•å…¥</b></label><input type="number" id="input-stability" value="0" min="0" oninput="updateAPCalc()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <span style="font-weight: bold;">å·²ç”¨: <span id="spent-ap">0</span> / <span id="max-ap">10</span></span>
                    <span id="submit-status" style="color: #27ae60; font-weight: bold;"></span>
                </div>
                <button onclick="submitDecision()" id="btn-submit" style="margin-top: 15px;">ğŸš€ æäº¤å†³ç­–</button>
            </div>
        </div>
        <div id="aid-area" style="margin-top: 25px; border-top: 2px dashed #dfe6e9; padding-top: 15px;">
            <h3>ğŸ¤ å›½é™…æ´åŠ© (è½¬è®© AP)</h3>
            <div style="display: flex; gap: 10px;">
                <select id="aid-target" style="flex: 2;"><option value="">-- é€‰æ‹©å¯¹è±¡ --</option></select>
                <input type="number" id="aid-amount" placeholder="æ•°é‡" min="1" style="flex: 1;">
            </div>
            <button onclick="sendAid()" style="background-color: #f39c12; color: white;">ğŸ’¸ è½¬è´¦</button>
        </div>
        <div id="dead-message" class="hidden" style="text-align: center; color: #c0392b; padding: 30px;"><h2>ğŸ’€ å›½å®¶å·²å´©æºƒ</h2><p>æƒå¨å½’é›¶ï¼Œè¯·è¯·æ±‚æ´åŠ©å¤æ´»ã€‚</p></div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const SUPABASE_URL = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // ==========================================

        let myTeamId = null, currentRoomId = null, myMaxAP = 10, myChart = null;

        window.onload = async function() {
            const savedTeamId = localStorage.getItem('bod_team_id');
            const savedRoomId = localStorage.getItem('bod_room_id');
            if (savedTeamId && savedRoomId) studentReconnect(savedTeamId, savedRoomId);
        };

        function checkTeacherPassword() {
            const room = document.getElementById('teacher-room-select').value;
            const pwd = prompt(`è¯·è¾“å…¥æˆ¿é—´ ${room} ç®¡ç†å¯†ç :`);
            if (pwd === room + "419") teacherLogin(room);
            else if (pwd !== null) alert("å¯†ç é”™è¯¯ï¼");
        }

        async function teacherLogin(roomId) {
            currentRoomId = roomId;
            const { data } = await supabaseClient.from('game_rooms').select('*').eq('id', roomId).single();
            if (!data) return alert("æˆ¿é—´ä¸å­˜åœ¨");
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('teacher-dashboard').classList.remove('hidden');
            document.getElementById('current-room-display').innerText = `æˆ¿é—´: ${currentRoomId}`;
            initChart(); subscribeToGame(); fetchTeamList(); fetchHistoryAndDraw(); updateTeacherStats(data);
        }

        async function studentLogin() {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const { data, error } = await supabaseClient.from('teams').select('*').eq('username', user).eq('password', pass).single();
            if (error || !data) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯ï¼");
            myTeamId = data.id; currentRoomId = data.room_id;
            localStorage.setItem('bod_team_id', myTeamId); localStorage.setItem('bod_room_id', currentRoomId);
            await supabaseClient.from('teams').update({ is_active: true }).eq('id', myTeamId);
            initStudentUI(data);
        }

        async function studentReconnect(tid, rid) {
            const { data } = await supabaseClient.from('teams').select('*').eq('id', tid).single();
            if(data) { myTeamId = tid; currentRoomId = rid; initStudentUI(data); }
            else localStorage.clear();
        }

        function initStudentUI(teamData) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('student-dashboard').classList.remove('hidden');
            document.getElementById('s-display-name').innerText = teamData.name;
            document.getElementById('edit-name').value = teamData.name;
            document.getElementById('edit-members').value = teamData.members || '';
            updateLocalAP(teamData.ap_count); subscribeToGame(); fetchOtherTeams();
        }

        async function updateTeamInfo() {
            const name = document.getElementById('edit-name').value;
            const members = document.getElementById('edit-members').value;
            await supabaseClient.from('teams').update({ name, members }).eq('id', myTeamId);
            document.getElementById('s-display-name').innerText = name;
            alert("ä¿¡æ¯å·²æ›´æ–°");
        }

        async function assignRoles() {
            const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
            if(teams.length === 0) return alert("æ— äººåœ¨çº¿");
            const pattern = ['A', 'B', 'B', 'C', 'C'];
            let shuffled = teams.sort(() => Math.random() - 0.5);
            for (let i = 0; i < shuffled.length; i++) {
                const type = pattern[i % pattern.length];
                let ap = (type === 'A') ? 15 : (type === 'B' ? 12 : 8);
                await supabaseClient.from('teams').update({ country_type: type, ap_count: ap, authority: 100 }).eq('id', shuffled[i].id);
            }
            alert("åˆ†é…æˆåŠŸ");
        }

        async function submitDecision() {
            const p = parseInt(document.getElementById('input-prevention').value) || 0;
            const r = parseInt(document.getElementById('input-research').value) || 0;
            const s = parseInt(document.getElementById('input-stability').value) || 0;
            if (p+r+s > myMaxAP) return alert('APè¶…æ”¯');
            await supabaseClient.from('teams').update({ last_decision: {p, r, s} }).eq('id', myTeamId);
            document.getElementById('submit-status').innerText = 'âœ… å·²æäº¤';
            document.getElementById('btn-submit').disabled = true;
        }

        async function nextTurn() {
            if(!confirm("ç¡®å®šç»“ç®—ï¼Ÿ")) return;
            const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
            const { data: room } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
            let totalP = 0, totalR = 0, collapsed = 0;
            for (let t of teams) {
                const d = t.last_decision || {p:0, r:0, s:0};
                if (t.authority > 0) {
                    totalP += d.p * (t.country_type==='B'?1.5:1);
                    totalR += d.r * (t.country_type==='A'?2:1);
                } else collapsed++;
                let newAuth = Math.max(0, Math.min(100, t.authority - (5 + d.p*1.5)*(t.country_type==='A'?1.5:1) + d.s*3));
                let baseAP = (t.country_type==='A')?15:(t.country_type==='B'?12:8);
                await supabaseClient.from('teams').update({ authority: newAuth, last_decision: null, ap_count: baseAP }).eq('id', t.id);
            }
            let newR0 = Math.max(0.5, room.infection_rate - (totalP/(teams.length*2)*0.1) + collapsed*0.05);
            let newInf = Math.floor(room.infection_total * newR0);
            let newProg = Math.min(100, room.cure_progress + (totalR/(teams.length*5)));
            await supabaseClient.from('game_rooms').update({ turn: room.turn+1, infection_total: newInf, infection_rate: newR0, cure_progress: newProg }).eq('id', currentRoomId);
            await supabaseClient.from('game_logs').insert([{ room_id: currentRoomId, turn: room.turn+1, infection_total: newInf, infection_rate: newR0, cure_progress: newProg }]);
            alert("ç»“ç®—å®Œæˆ");
        }

        async function sendAid() {
            const targetId = document.getElementById('aid-target').value;
            const amount = parseInt(document.getElementById('aid-amount').value);
            if(!targetId || amount > myMaxAP || amount <= 0) return alert("æ— æ•ˆæ“ä½œ");
            updateLocalAP(myMaxAP - amount);
            await supabaseClient.from('teams').update({ ap_count: myMaxAP }).eq('id', myTeamId);
            const { data } = await supabaseClient.from('teams').select('ap_count').eq('id', targetId).single();
            await supabaseClient.from('teams').update({ ap_count: data.ap_count + amount }).eq('id', targetId);
            alert("è½¬è´¦æˆåŠŸ");
        }

        function subscribeToGame() {
            supabaseClient.channel('room-' + currentRoomId)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'teams', filter: `room_id=eq.${currentRoomId}` }, (payload) => {
                const t = payload.new;
                if(!myTeamId) fetchTeamList();
                else if(t.id === myTeamId) {
                    if(t.ap_count > myMaxAP) {
                        document.getElementById('aid-badge').classList.remove('hidden');
                        setTimeout(() => document.getElementById('aid-badge').classList.add('hidden'), 3000);
                    }
                    updateLocalAP(t.ap_count);
                    document.getElementById('s-country-type').innerText = t.country_type;
                    document.getElementById('s-country-type').className = "status-" + t.country_type;
                    document.getElementById('s-auth').innerText = Math.floor(t.authority);
                    if(t.authority <= 0) document.getElementById('input-area').classList.add('hidden'), document.getElementById('dead-message').classList.remove('hidden');
                    else document.getElementById('input-area').classList.remove('hidden'), document.getElementById('dead-message').classList.add('hidden');
                }
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'game_rooms', filter: `id=eq.${currentRoomId}` }, (payload) => {
                if(!myTeamId) { updateTeacherStats(payload.new); fetchHistoryAndDraw(); }
                else { 
                    document.getElementById('submit-status').innerText = ''; 
                    document.getElementById('btn-submit').disabled = false; 
                    alert("æ–°ä¸€è½®å¼€å§‹ï¼"); 
                }
            }).subscribe();
        }

        function updateLocalAP(val) { myMaxAP = val; document.getElementById('s-ap').innerText = val; updateAPCalc(); }
        function updateAPCalc() {
            const total = (parseInt(document.getElementById('input-prevention').value)||0) + (parseInt(document.getElementById('input-research').value)||0) + (parseInt(document.getElementById('input-stability').value)||0);
            document.getElementById('spent-ap').innerText = total;
            document.getElementById('spent-ap').style.color = total > myMaxAP ? 'red' : 'black';
            if(document.getElementById('submit-status').innerText === '') document.getElementById('btn-submit').disabled = total > myMaxAP;
        }

        async function fetchTeamList() {
            const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).order('username');
            document.getElementById('t-online-count').innerText = `${teams.filter(t=>t.is_active).length} / 15`;
            document.getElementById('team-list').innerHTML = teams.map(t => `
                <div class="monitor-row ${t.authority<=0?'dead':''}" style="${!t.is_active?'opacity:0.4':''}">
                    <div style="width:30%"><b>${t.name}</b> <small>(${t.username})</small>${t.is_active?'<span class="active-badge">åœ¨çº¿</span>':''}</div>
                    <div style="width:10%">${t.country_type}</div>
                    <div style="width:15%">AP: ${t.ap_count}</div>
                    <div style="width:20%">æƒå¨: ${Math.floor(t.authority)}</div>
                    <div style="width:10%">${t.last_decision?'âœ…':'â³'}</div>
                    <div style="width:15%; font-size:10px;">${t.members||''}</div>
                </div>`).join('');
        }

        function updateTeacherStats(r) {
            document.getElementById('t-turn').innerText = r.turn;
            document.getElementById('t-infection').innerText = r.infection_total.toLocaleString();
            document.getElementById('t-r0').innerText = r.infection_rate.toFixed(2);
            document.getElementById('t-cure').innerText = r.cure_progress.toFixed(1) + '%';
        }

        function initChart() {
            myChart = new Chart(document.getElementById('infectionChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'æ„ŸæŸ“', data: [], borderColor: '#ff7675', yAxisID: 'y' }, { label: 'è§£è¯', data: [], borderColor: '#55efc4', yAxisID: 'y1' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: {position:'left'}, y1: {position:'right', min:0, max:100} } }
            });
        }

        async function fetchHistoryAndDraw() {
            const { data } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('turn');
            if(data && myChart) {
                myChart.data.labels = data.map(l => "R"+l.turn);
                myChart.data.datasets[0].data = data.map(l => l.infection_total);
                myChart.data.datasets[1].data = data.map(l => l.cure_progress);
                myChart.update();
            }
        }

        async function fetchOtherTeams() {
            const { data } = await supabaseClient.from('teams').select('id, name').eq('room_id', currentRoomId).neq('id', myTeamId).eq('is_active', true);
            const s = document.getElementById('aid-target');
            s.innerHTML = '<option value="">-- é€‰æ‹©å¯¹è±¡ --</option>' + data.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        function logout() { if(confirm("é€€å‡ºï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        async function resetGame() {
            if(confirm("ç¡®å®šæ¸…ç©ºæœ¬æˆ¿é—´è¿›åº¦ï¼Ÿ")) {
                await supabaseClient.rpc('reset_room_data', { target_room_id: parseInt(currentRoomId) });
                location.reload();
            }
        }
    </script>
</body>
</html>