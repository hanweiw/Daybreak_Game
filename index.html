<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ´æ™“è¡ŒåŠ¨ v6.6 | å®Œæ•´ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --dark: #2c3e50; --gray: #95a5a6; }
        body { font-family: -apple-system, sans-serif; background: #f4f7f6; margin: 0; padding: 15px; }
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        #screen-login { max-width: 450px; margin: 60px auto; border-top: 6px solid var(--primary); }
        .login-nav { display: flex; margin-bottom: 20px; background: #eee; border-radius: 8px; padding: 5px; }
        .login-nav button { flex: 1; padding: 10px; background: none; color: #666; }
        .login-nav button.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        #screen-teacher .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-box { background: var(--dark); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .monitor-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; font-size: 13px; }
        
        #screen-student .team-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        #screen-student .ap-circle { width: 100px; height: 100px; border-radius: 50%; border: 8px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .status-A { color: #e67e22; background: #fff3cd; padding: 3px 8px; border-radius: 4px; }
        .status-B { color: #c0392b; background: #f8d7da; padding: 3px 8px; border-radius: 4px; }
        .status-C { color: #27ae60; background: #d4edda; padding: 3px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="main-wrapper">

    <div id="screen-login" class="card">
        <h2 style="margin-top:0">ğŸ›¡ï¸ ç ´æ™“è¡ŒåŠ¨</h2>
        <div class="login-nav">
            <button id="tab-stu" class="active" onclick="toggleLoginRole('student')">å­¦ç”Ÿå…¥å£</button>
            <button id="tab-tea" onclick="toggleLoginRole('teacher')">æ•™å¸ˆå…¥å£</button>
        </div>

        <div id="form-student">
            <input type="text" id="stu-user" placeholder="è´¦å· (å¦‚: 100101)">
            <input type="password" id="stu-pass" placeholder="éšæœºå¯†ç ">
            <button onclick="studentLogin()" style="background: var(--primary); color: white; width: 100%; padding: 15px;">è¿›å…¥å®éªŒ</button>
        </div>

        <div id="form-teacher" class="hidden">
            <select id="tea-room">
                <option value="1001">æˆ¿é—´ 1001</option><option value="1002">æˆ¿é—´ 1002</option>
                <option value="1003">æˆ¿é—´ 1003</option><option value="1004">æˆ¿é—´ 1004</option>
            </select>
            <button onclick="teacherLoginVerify()" style="background: var(--dark); color: white; width: 100%; padding: 15px;">ç®¡ç†åå°</button>
        </div>
    </div>

    <div id="screen-teacher" class="hidden">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>ğŸ“Š ç›‘æ§ä¸­å¿ƒ <span id="tag-room" style="font-size:14px; font-weight:normal;"></span></h3>
            <div style="display:flex; gap:8px;">
                <button onclick="logout()" style="background:var(--gray); color:white; padding:8px 12px; font-size:12px;">ç™»å‡º</button>
                <button onclick="exportCSV()" style="background:var(--success); color:white; padding:8px 12px; font-size:12px;">å¯¼å‡ºCSV</button>
                <button onclick="resetGame()" style="background:var(--danger); color:white; padding:8px 12px; font-size:12px;">é‡ç½®åœºæ¬¡</button>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><h4>å®éªŒåœºæ¬¡</h4><p id="t-exp">1</p></div>
            <div class="stat-box"><h4>å½“å‰è½®æ•°</h4><p id="t-turn">1</p></div>
            <div class="stat-box"><h4>å…¨çƒæ„ŸæŸ“</h4><p id="t-inf">0</p></div>
            <div class="stat-box"><h4>è§£è¯è¿›åº¦</h4><p id="t-cure">0%</p></div>
        </div>

        <div class="card" style="margin-top:15px;"><canvas id="infectionChart" style="height:200px;"></canvas></div>

        <div class="card">
            <h4>æµç¨‹æ§åˆ¶</h4>
            <div style="display:flex; gap:10px;">
                <button onclick="assignRoles()" style="background:var(--primary); color:white; flex:1; padding:12px;">ğŸ² éšæœºåˆ†é…å±æ€§</button>
                <button id="btn-next-turn" onclick="nextTurn()" style="background:var(--danger); color:white; flex:1; padding:12px;">âš ï¸ ç»“ç®—æœ¬è½®</button>
            </div>
        </div>

        <h4>å°ç»„å®æ—¶çŠ¶æ€: <span id="t-online">0</span> ç»„åœ¨çº¿</h4>
        <div id="team-list"></div>
    </div>

    <div id="screen-student" class="hidden">
        <div class="team-header">
            <h2 id="s-team-display" style="margin:0;">è½½å…¥ä¸­...</h2>
            <button onclick="logout()" style="background:var(--gray); color:white; padding:5px 12px; font-size:12px;">ç™»å‡º</button>
        </div>

        <div class="card" style="margin-top:15px; border-left: 5px solid var(--primary);">
            <details>
                <summary style="cursor:pointer; font-weight:bold; color:var(--primary)">âœï¸ ä¿®æ”¹èµ„æ–™ (ä»…é™æœ¬åœº)</summary>
                <input type="text" id="edit-name" placeholder="å›½å®¶åç§°">
                <textarea id="edit-members" placeholder="æˆå‘˜å§“åä¸å­¦å·"></textarea>
                <button onclick="updateTeamInfo()" style="background:var(--primary); color:white; padding:8px; width:100px;">ä¿å­˜</button>
            </details>
        </div>

        <div class="card" style="text-align:center;">
            <span id="s-type-tag" style="font-weight:bold;">ç­‰å¾…åˆ†é…...</span>
            <div class="ap-circle" style="margin-top:15px;">
                <span style="font-size:12px;">å¯ç”¨ AP</span>
                <span id="s-ap" style="font-size:32px; font-weight:bold;">0</span>
            </div>
            <p>æƒå¨å€¼: <b id="s-auth" style="color:var(--danger)">0</b> / 100</p>
        </div>

        <div id="input-area" class="card">
            <h4>ğŸ“ è½®æ¬¡å†³ç­–</h4>
            <label>ğŸ›¡ï¸ é˜²æ§æŠ•å…¥</label><input type="number" id="in-p" value="0" min="0" oninput="calcAP()">
            <label>ğŸ§ª ç ”å‘æŠ•å…¥</label><input type="number" id="in-r" value="0" min="0" oninput="calcAP()">
            <label>ğŸ“¢ ç»´ç¨³æŠ•å…¥</label><input type="number" id="in-s" value="0" min="0" oninput="calcAP()">
            <div style="margin-top:10px; font-weight:bold;">
                æ€»æŠ•å…¥: <span id="s-spent">0</span> / <span id="s-max">0</span>
                <span id="s-status" style="float:right; color:var(--success)"></span>
            </div>
            <button id="btn-submit" onclick="submitDecision()" style="background:var(--primary); color:white; width:100%; padding:15px; margin-top:10px;">ğŸš€ æäº¤å†³ç­–</button>
        </div>
    </div>

</div>

<script>
    const SUPABASE_URL = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myTeamId = null, currentRoomId = null, myMaxAP = 10, myExpId = 1, myChart = null;

    function toggleLoginRole(role) {
        document.getElementById('form-student').classList.toggle('hidden', role !== 'student');
        document.getElementById('form-teacher').classList.toggle('hidden', role !== 'teacher');
        document.getElementById('tab-stu').classList.toggle('active', role === 'student');
        document.getElementById('tab-tea').classList.toggle('active', role === 'teacher');
    }

    function navigateTo(screen) {
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-teacher').classList.add('hidden');
        document.getElementById('screen-student').classList.add('hidden');
        document.getElementById(screen).classList.remove('hidden');
    }

    // [æ–­çº¿é‡è¿é€»è¾‘æ•´åˆ]
    window.onload = async () => {
        const tid = localStorage.getItem('bod_team_id'), rid = localStorage.getItem('bod_room_id');
        const teaRoom = localStorage.getItem('bod_tea_room');
        
        if (tid && rid) {
            const { data } = await supabaseClient.from('teams').select('*').eq('id', tid).single();
            if(data) { myTeamId = tid; currentRoomId = rid; initStudentUI(data); return; }
        }
        
        if (teaRoom) {
            currentRoomId = teaRoom; initTeacherUI();
        }
    };

    function logout() {
        if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }

    async function studentLogin() {
        const u = document.getElementById('stu-user').value.trim(), p = document.getElementById('stu-pass').value.trim();
        const { data, error } = await supabaseClient.from('teams').select('*').eq('username', u).eq('password', p).single();
        if (error || !data) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
        myTeamId = data.id; currentRoomId = data.room_id;
        localStorage.setItem('bod_team_id', myTeamId); localStorage.setItem('bod_room_id', currentRoomId);
        await supabaseClient.from('teams').update({ is_active: true }).eq('id', myTeamId);
        initStudentUI(data);
    }

    function teacherLoginVerify() {
        const room = document.getElementById('tea-room').value;
        const pwd = prompt("è¯·è¾“å…¥ç®¡ç†å¯†ç :");
        if (pwd === room + "419") { 
            currentRoomId = room; 
            localStorage.setItem('bod_tea_room', room);
            initTeacherUI(); 
        } else if (pwd !== null) alert("å¯†ç é”™è¯¯");
    }

    async function initTeacherUI() {
        navigateTo('screen-teacher');
        document.getElementById('tag-room').innerText = `Room ${currentRoomId}`;
        const { data } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
        myExpId = data.experiment_id;
        initChart(); subscribeToGame(); fetchTeamList(); fetchHistoryAndDraw(); updateTeacherStats(data);
    }

    function initStudentUI(teamData) {
        navigateTo('screen-student');
        document.getElementById('s-team-display').innerText = teamData.name;
        document.getElementById('edit-name').value = teamData.name;
        document.getElementById('edit-members').value = teamData.members;
        myMaxAP = teamData.ap_count; updateStudentUI(teamData); subscribeToGame();
    }

    // [ç»“ç®—æ ¸å¿ƒé€»è¾‘ - åŠ äº†é˜²è¿å‡»é”]
    async function nextTurn() {
        if(!confirm("ç¡®å®šç»“ç®—æœ¬è½®ï¼Ÿ")) return;
        
        const btn = document.getElementById('btn-next-turn');
        btn.disabled = true;
        btn.innerText = "ç»“ç®—ä¸­...";

        try {
            const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
            const { data: room } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
            
            let sumP = 0, sumR = 0, coll = 0;
            for (let t of teams) {
                const d = t.last_decision || {p:0, r:0, s:0};
                if (t.authority > 0) {
                    sumP += d.p * (t.country_type==='B'?1.5:1);
                    sumR += d.r * (t.country_type==='A'?2:1);
                } else coll++;
                let nAuth = Math.max(0, Math.min(100, t.authority - (5 + d.p*1.2)*(t.country_type==='A'?1.3:1) + d.s*3));
                let bAP = (t.country_type==='A')?15:(t.country_type==='B'?12:8);
                await supabaseClient.from('teams').update({ authority: nAuth, last_decision: null, ap_count: bAP }).eq('id', t.id);
            }
            
            let nR0 = Math.max(0.5, room.infection_rate - (sumP/(teams.length*2.5)*0.1) + coll*0.05);
            let nInf = Math.floor(room.infection_total * nR0);
            let nCure = Math.min(100, room.cure_progress + (sumR/(teams.length*5)));
            
            await supabaseClient.from('game_rooms').update({ turn: room.turn+1, infection_total: nInf, infection_rate: nR0, cure_progress: nCure }).eq('id', currentRoomId);
            await supabaseClient.from('game_logs').insert([{ room_id: currentRoomId, exp_id: room.experiment_id, turn: room.turn, infection_total: nInf, infection_rate: nR0, cure_progress: nCure }]);
        } catch (error) {
            console.error(error);
            alert("ç»“ç®—å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ï¼");
        } finally {
            btn.disabled = false;
            btn.innerText = "âš ï¸ ç»“ç®—æœ¬è½®";
        }
    }

    async function resetGame() {
        if(!confirm("ç¡®å®šé‡ç½®ï¼Ÿè¿™å°†å¼€å¯æ–°çš„å®éªŒåœºæ¬¡(Exp ID +1)")) return;
        await supabaseClient.rpc('reset_room_data', { target_room_id: parseInt(currentRoomId) });
        location.reload();
    }

    async function exportCSV() {
        const { data: logs } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('created_at', { ascending: true });
        if(!logs.length) return alert("æ— æ•°æ®");
        let csv = "\uFEFFå®éªŒåœºæ¬¡,è½®æ•°,æ„ŸæŸ“æ•°,R0,è§£è¯è¿›åº¦,è®°å½•æ—¶é—´\n";
        logs.forEach(l => csv += `${l.exp_id},${l.turn},${l.infection_total},${l.infection_rate},${l.cure_progress},${l.created_at}\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ExpData_Room${currentRoomId}.csv`;
        link.click();
    }

    function calcAP() {
        const p = parseInt(document.getElementById('in-p').value)||0;
        const r = parseInt(document.getElementById('in-r').value)||0;
        const s = parseInt(document.getElementById('in-s').value)||0;
        const total = p + r + s;
        document.getElementById('s-spent').innerText = total;
        document.getElementById('s-spent').style.color = total > myMaxAP ? 'red' : 'black';
        document.getElementById('btn-submit').disabled = total > myMaxAP;
    }

    async function submitDecision() {
        const p = parseInt(document.getElementById('in-p').value)||0, r = parseInt(document.getElementById('in-r').value)||0, s = parseInt(document.getElementById('in-s').value)||0;
        await supabaseClient.from('teams').update({ last_decision: {p, r, s} }).eq('id', myTeamId);
        document.getElementById('s-status').innerText = "âœ… å·²æäº¤";
        document.getElementById('btn-submit').disabled = true;
    }

    // [å®æ—¶ç›‘å¬ä¿®å¤ - æ­¤å¤„ä¾èµ– Supabase åå°å¼€å¯ Publications]
    function subscribeToGame() {
        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
            if(payload.table === 'teams' && payload.new.room_id == currentRoomId) {
                if(myTeamId) { if(payload.new.id == myTeamId) updateStudentUI(payload.new); }
                else fetchTeamList();
            }
            if(payload.table === 'game_rooms' && payload.new.id == currentRoomId) {
                if(myTeamId) { 
                    alert("æ–°ä¸€è½®å·²å¼€å§‹ï¼"); 
                    document.getElementById('s-status').innerText = ""; 
                    document.getElementById('btn-submit').disabled = false;
                } else { updateTeacherStats(payload.new); fetchHistoryAndDraw(); }
            }
        }).subscribe();
    }

    function updateStudentUI(t) {
        myMaxAP = t.ap_count;
        document.getElementById('s-ap').innerText = t.ap_count;
        document.getElementById('s-max').innerText = t.ap_count;
        document.getElementById('s-auth').innerText = Math.floor(t.authority);
        document.getElementById('s-type-tag').innerText = t.country_type === 'å¾…å®š' ? "ç­‰å¾…åˆ†é…..." : t.country_type + " å‹å›½å®¶";
        document.getElementById('s-type-tag').className = "status-" + t.country_type;
    }

    async function fetchTeamList() {
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).order('username');
        document.getElementById('t-online').innerText = teams.filter(t=>t.is_active).length;
        document.getElementById('team-list').innerHTML = teams.map(t => `
            <div class="monitor-row" style="${!t.is_active?'opacity:0.3':''}">
                <div style="width:35%"><b>${t.name}</b> <small>(${t.username})</small></div>
                <div style="width:15%"><span class="status-${t.country_type}">${t.country_type}</span></div>
                <div style="width:15%">AP:${t.ap_count}</div>
                <div style="width:15%">æƒ:${Math.floor(t.authority)}</div>
                <div style="width:10%">${t.last_decision?'âœ…':'â³'}</div>
            </div>`).join('');
    }

    function updateTeacherStats(r) {
        document.getElementById('t-exp').innerText = r.experiment_id;
        document.getElementById('t-turn').innerText = r.turn;
        document.getElementById('t-inf').innerText = r.infection_total.toLocaleString();
        document.getElementById('t-cure').innerText = r.cure_progress.toFixed(1) + '%';
    }

    function initChart() {
        myChart = new Chart(document.getElementById('infectionChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'æ„ŸæŸ“', data: [], borderColor: '#ff7675' }, { label: 'è§£è¯', data: [], borderColor: '#55efc4' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    async function fetchHistoryAndDraw() {
        const { data: logs } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('turn');
        const { data: room } = await supabaseClient.from('game_rooms').select('experiment_id').eq('id', currentRoomId).single();
        const currentLogs = logs.filter(l => l.exp_id === room.experiment_id);
        if(myChart) {
            myChart.data.labels = currentLogs.map(l => "R"+l.turn);
            myChart.data.datasets[0].data = currentLogs.map(l => l.infection_total);
            myChart.data.datasets[1].data = currentLogs.map(l => l.cure_progress);
            myChart.update();
        }
    }

    async function updateTeamInfo() {
        const name = document.getElementById('edit-name').value;
        const members = document.getElementById('edit-members').value;
        await supabaseClient.from('teams').update({ name, members }).eq('id', myTeamId);
        document.getElementById('s-team-display').innerText = name;
        alert("èµ„æ–™å·²æ›´æ–°");
    }
    async function assignRoles() {
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
        const p = ['A', 'B', 'B', 'C', 'C'];
        for (let i = 0; i < teams.length; i++) {
            let type = p[i % p.length], ap = (type==='A'?15:(type==='B'?12:8));
            await supabaseClient.from('teams').update({ country_type: type, ap_count: ap, authority: 100 }).eq('id', teams[i].id);
        }
    }
</script>
</body>
</html>