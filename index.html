<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ´æ™“è¡ŒåŠ¨ v6.7 | æ²‰æµ¸å¼é©¾é©¶èˆ±ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --dark: #2c3e50; --gray: #95a5a6; --bg: #f0f4f8; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .hidden { display: none !important; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; outline: none; }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        input, select, textarea { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        /* --- ç™»å½• UI --- */
        #screen-login { max-width: 400px; margin: 80px auto; border-top: 5px solid var(--primary); }
        .login-nav { display: flex; margin-bottom: 15px; background: #eee; border-radius: 6px; padding: 4px; }
        .login-nav button { flex: 1; padding: 8px; background: none; color: #666; }
        .login-nav button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* --- æ•™å¸ˆç«¯é©¾é©¶èˆ± UI --- */
        .tea-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #screen-teacher-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: start; height: calc(100vh - 90px); }
        .left-panel { display: flex; flex-direction: column; gap: 15px; }
        .right-panel { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); height: 100%; overflow-y: auto; box-sizing: border-box; border-top: 4px solid var(--dark); }
        
        .stat-grid-small { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-box-small { background: var(--dark); color: white; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-box-small h4 { margin: 0; font-size: 12px; font-weight: normal; color: #cbd5e1; }
        .stat-box-small p { margin: 4px 0 0; font-size: 22px; font-weight: bold; }

        .chart-row { display: flex; gap: 15px; }
        .chart-box { flex: 1; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-box h4 { margin: 0 0 8px 0; font-size: 13px; color: #64748b; text-align: center; }
        .chart-container { height: 180px; position: relative; }

        .team-compact { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; margin-bottom: 8px; }
        .team-compact.dead { opacity: 0.5; filter: grayscale(1); }
        .team-compact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .team-compact-stats { display: flex; justify-content: space-between; font-size: 12px; color: #475569; }

        /* --- æ ‡ç­¾ UI --- */
        .status-A { color: #d97706; background: #fef3c7; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-B { color: #b91c1c; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-C { color: #15803d; background: #dcfce3; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        
        /* --- å­¦ç”Ÿç«¯ UI (ä¿æŒæ¸…çˆ½) --- */
        #screen-student { max-width: 600px; margin: 0 auto; }
        #screen-student .ap-circle { width: 90px; height: 90px; border-radius: 50%; border: 6px solid var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 15px; }
    </style>
</head>
<body>

    <div id="screen-login" class="card">
        <h2 style="text-align:center; color:var(--dark); margin-top:0;">ğŸ›¡ï¸ ç ´æ™“è¡ŒåŠ¨ç³»ç»Ÿ</h2>
        <div class="login-nav">
            <button id="tab-stu" class="active" onclick="toggleLoginRole('student')">å­¦ç”Ÿå…¥å£</button>
            <button id="tab-tea" onclick="toggleLoginRole('teacher')">æŒ‡æŒ¥å…¥å£</button>
        </div>

        <div id="form-student">
            <input type="text" id="stu-user" placeholder="åˆ†é…çš„è´¦å· (å¦‚: 100101)">
            <input type="password" id="stu-pass" placeholder="éšæœºå¯†ç ">
            <button onclick="studentLogin()" style="background: var(--primary); color: white; width: 100%; padding: 12px; margin-top:10px;">è¿›å…¥å®éªŒ</button>
        </div>

        <div id="form-teacher" class="hidden">
            <select id="tea-room">
                <option value="1001">æŒ‡æŒ¥æˆ¿é—´ 1001</option><option value="1002">æŒ‡æŒ¥æˆ¿é—´ 1002</option>
                <option value="1003">æŒ‡æŒ¥æˆ¿é—´ 1003</option><option value="1004">æŒ‡æŒ¥æˆ¿é—´ 1004</option>
            </select>
            <button onclick="teacherLoginVerify()" style="background: var(--dark); color: white; width: 100%; padding: 12px; margin-top:10px;">è¿›å…¥ç›‘æ§å°</button>
        </div>
    </div>

    <div id="screen-teacher" class="hidden">
        
        <div class="tea-header">
            <h3 style="margin:0; color:var(--dark);">ğŸŒ ç ´æ™“è¡ŒåŠ¨ç›‘æ§å° <span id="tag-room" style="color:var(--primary); font-size:15px; margin-left:10px;"></span></h3>
            <div style="display:flex; gap:10px;">
                <button onclick="logout()" style="background:var(--gray); color:white; padding:6px 15px; font-size:13px;">ç™»å‡º</button>
                <button onclick="exportCSV()" style="background:var(--success); color:white; padding:6px 15px; font-size:13px;">ğŸ“¥ å¯¼å‡ºCSV</button>
                <button onclick="resetGame()" style="background:var(--danger); color:white; padding:6px 15px; font-size:13px;">ğŸ”„ é‡ç½®åœºæ¬¡</button>
            </div>
        </div>

        <div id="screen-teacher-layout">
            
            <div class="left-panel">
                
                <div class="stat-grid-small">
                    <div class="stat-box-small"><h4>å®éªŒåœºæ¬¡</h4><p id="t-exp">1</p></div>
                    <div class="stat-box-small"><h4>å½“å‰è½®æ•°</h4><p id="t-turn">1</p></div>
                    <div class="stat-box-small"><h4>å…¨çƒæ„ŸæŸ“æ•°</h4><p id="t-inf" style="color:#ff8a65;">0</p></div>
                    <div class="stat-box-small"><h4>è§£è¯è¿›åº¦</h4><p id="t-cure" style="color:#69f0ae;">0%</p></div>
                </div>

                <div class="chart-row">
                    <div class="chart-box">
                        <h4>ğŸ“‰ å…¨çƒæ„ŸæŸ“è”“å»¶è¶‹åŠ¿</h4>
                        <div class="chart-container"><canvas id="chart-inf"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <h4>ğŸ§ª è§£è¯ç ”å‘è¿›åº¦ (%)</h4>
                        <div class="chart-container"><canvas id="chart-cure"></canvas></div>
                    </div>
                </div>

                <div class="card" style="margin-bottom:0; padding:12px;">
                    <div style="display:flex; gap:12px;">
                        <button onclick="assignRoles()" style="background:var(--primary); color:white; flex:1; padding:12px; font-size:15px;">ğŸ² éšæœºåˆ†é…å±æ€§</button>
                        <button id="btn-next-turn" onclick="nextTurn()" style="background:var(--danger); color:white; flex:1; padding:12px; font-size:15px; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);">âš ï¸ ç»“ç®—æœ¬è½®å†³ç­–</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #f1f5f9; padding-bottom:10px; margin-bottom:15px;">
                    <h4 style="margin:0; color:var(--dark);">å°ç»„å®æ—¶çŠ¶æ€</h4>
                    <span style="background:#e2e8f0; font-size:12px; padding:2px 8px; border-radius:10px; font-weight:bold;"><span id="t-online" style="color:var(--success);">0</span> ç»„åœ¨çº¿</span>
                </div>
                <div id="team-list"></div>
            </div>
        </div>
    </div>

    <div id="screen-student" class="hidden">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:12px 20px;">
            <h2 id="s-team-display" style="margin:0; color:var(--dark); font-size:20px;">è½½å…¥ä¸­...</h2>
            <button onclick="logout()" style="background:var(--gray); color:white; padding:6px 15px; font-size:12px;">ç™»å‡º</button>
        </div>

        <div class="card" style="border-left: 4px solid var(--primary); padding:12px 20px;">
            <details>
                <summary style="cursor:pointer; font-weight:bold; color:var(--primary); font-size:14px;">âœï¸ ç™»è®°ç»„å‘˜ä¿¡æ¯ (ç‚¹å‡»å±•å¼€)</summary>
                <div style="margin-top:10px;">
                    <input type="text" id="edit-name" placeholder="å›½å®¶åç§°">
                    <textarea id="edit-members" placeholder="æˆå‘˜å§“åä¸å­¦å·" rows="2"></textarea>
                    <button onclick="updateTeamInfo()" style="background:var(--primary); color:white; padding:8px 20px; font-size:13px;">ğŸ’¾ ä¿å­˜èµ„æ–™</button>
                </div>
            </details>
        </div>

        <div class="card" style="text-align:center;">
            <span id="s-type-tag" style="font-weight:bold; font-size:14px;">ç­‰å¾…æŒ‡æŒ¥åˆ†é…...</span>
            <div class="ap-circle" style="margin-top:20px;">
                <span style="font-size:12px; color:#666;">å¯ç”¨ AP</span>
                <span id="s-ap" style="font-size:36px; font-weight:bold; color:var(--dark);">0</span>
            </div>
            <p style="margin-bottom:5px;">æ”¿åºœæƒå¨å€¼: <b id="s-auth" style="color:var(--danger); font-size:20px;">0</b> / 100</p>
        </div>

        <div id="input-area" class="card">
            <h4 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“ æœ¬è½®èµ„æºæŠ•å…¥</h4>
            <div style="display:grid; grid-template-columns: auto 1fr; gap:10px; align-items:center;">
                <label>ğŸ›¡ï¸ é˜²æ§</label><input type="number" id="in-p" value="0" min="0" oninput="calcAP()">
                <label>ğŸ§ª ç ”å‘</label><input type="number" id="in-r" value="0" min="0" oninput="calcAP()">
                <label>ğŸ“¢ ç»´ç¨³</label><input type="number" id="in-s" value="0" min="0" oninput="calcAP()">
            </div>
            <div style="margin-top:15px; background:#f8fafc; padding:10px; border-radius:6px; font-weight:bold; font-size:14px;">
                æ€»æŠ•å…¥: <span id="s-spent">0</span> / <span id="s-max">0</span>
                <span id="s-status" style="float:right; color:var(--success)"></span>
            </div>
            <button id="btn-submit" onclick="submitDecision()" style="background:var(--primary); color:white; width:100%; padding:14px; margin-top:15px; font-size:16px;">ğŸš€ ç¡®è®¤æäº¤</button>
        </div>
    </div>

<script>
    // ================== æ ¸å¿ƒé…ç½® ==================
    const SUPABASE_URL = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myTeamId = null, currentRoomId = null, myMaxAP = 10, chartInf = null, chartCure = null;

    // ================== ç•Œé¢å¯¼èˆªä¸é‡è¿ ==================
    function toggleLoginRole(role) {
        document.getElementById('form-student').classList.toggle('hidden', role !== 'student');
        document.getElementById('form-teacher').classList.toggle('hidden', role !== 'teacher');
        document.getElementById('tab-stu').classList.toggle('active', role === 'student');
        document.getElementById('tab-tea').classList.toggle('active', role === 'teacher');
    }

    function navigateTo(screen) {
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-teacher').classList.add('hidden');
        document.getElementById('screen-student').classList.add('hidden');
        document.getElementById(screen).classList.remove('hidden');
    }

    window.onload = async () => {
        const tid = localStorage.getItem('bod_team_id'), rid = localStorage.getItem('bod_room_id');
        const teaRoom = localStorage.getItem('bod_tea_room');
        
        if (tid && rid) {
            const { data } = await supabaseClient.from('teams').select('*').eq('id', tid).single();
            if(data) { myTeamId = tid; currentRoomId = rid; initStudentUI(data); return; }
        }
        if (teaRoom) { currentRoomId = teaRoom; initTeacherUI(); }
    };

    function logout() {
        if(confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) { localStorage.clear(); location.reload(); }
    }

    // ================== ç™»å½•å¤„ç† ==================
    async function studentLogin() {
        const u = document.getElementById('stu-user').value.trim(), p = document.getElementById('stu-pass').value.trim();
        const { data, error } = await supabaseClient.from('teams').select('*').eq('username', u).eq('password', p).single();
        if (error || !data) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯ï¼");
        myTeamId = data.id; currentRoomId = data.room_id;
        localStorage.setItem('bod_team_id', myTeamId); localStorage.setItem('bod_room_id', currentRoomId);
        await supabaseClient.from('teams').update({ is_active: true }).eq('id', myTeamId);
        initStudentUI(data);
    }

    function teacherLoginVerify() {
        const room = document.getElementById('tea-room').value;
        const pwd = prompt("è¯·è¾“å…¥æˆ¿é—´ç®¡ç†å¯†ç :");
        if (pwd === room + "419") { 
            currentRoomId = room; localStorage.setItem('bod_tea_room', room); initTeacherUI(); 
        } else if (pwd !== null) alert("å¯†ç é”™è¯¯");
    }

    // ================== åˆå§‹åŒ–é€»è¾‘ ==================
    async function initTeacherUI() {
        navigateTo('screen-teacher');
        document.getElementById('tag-room').innerText = `[æˆ¿é—´ ${currentRoomId}]`;
        const { data } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
        initCharts(); subscribeToGame(); fetchTeamList(); fetchHistoryAndDraw(); updateTeacherStats(data);
    }

    function initStudentUI(teamData) {
        navigateTo('screen-student');
        document.getElementById('s-team-display').innerText = teamData.name;
        document.getElementById('edit-name').value = teamData.name;
        document.getElementById('edit-members').value = teamData.members;
        myMaxAP = teamData.ap_count; updateStudentUI(teamData); subscribeToGame();
    }

    // ================== çº¯å‰ç«¯é‡ç½®é€»è¾‘ (å®Œç¾è§£å†³å¡æ­») ==================
    async function resetGame() {
        if(!confirm("âš ï¸ ç¡®å®šé‡ç½®å½“å‰å®éªŒï¼Ÿ\næ­¤æ“ä½œä¼šè‡ªåŠ¨å¼€å¯æ–°åœºæ¬¡ï¼Œä»¥å¾€æ•°æ®ä¼šä¿å­˜åœ¨åå°å¯ä»¥ä¸‹è½½ã€‚")) return;
        
        // 1. å…ˆæŸ¥å‡ºå½“å‰çš„ experiment_id
        const { data: room } = await supabaseClient.from('game_rooms').select('experiment_id').eq('id', currentRoomId).single();
        const nextExpId = (room?.experiment_id || 1) + 1;

        // 2. å¼ºåˆ¶ç”¨å‰ç«¯è¿›è¡Œæ›´æ–°ï¼Œç»•è¿‡å­˜å‚¨è¿‡ç¨‹çš„ bug
        const { error: e1 } = await supabaseClient.from('game_rooms')
            .update({ experiment_id: nextExpId, turn: 1, infection_total: 1000, infection_rate: 1.5, cure_progress: 0, global_authority: 100 })
            .eq('id', currentRoomId);
            
        const { error: e2 } = await supabaseClient.from('teams')
            .update({ country_type: 'å¾…å®š', ap_count: 10, authority: 100, last_decision: null, is_active: false })
            .eq('room_id', currentRoomId);

        if (e1 || e2) {
            alert("é‡ç½®å‡ºç°ç½‘ç»œå¼‚å¸¸ï¼");
        } else {
            alert("âœ… å·²æˆåŠŸåˆ‡æ¢åˆ°ç¬¬ " + nextExpId + " åœºå®éªŒï¼");
            location.reload();
        }
    }

    // ================== ç»“ç®—é€»è¾‘ (é˜²è¿å‡»ç‰ˆ) ==================
    async function nextTurn() {
        if(!confirm("ç¡®å®šç»“ç®—æœ¬è½®å¹¶å¼€å¯ä¸‹ä¸€è½®ï¼Ÿ")) return;
        const btn = document.getElementById('btn-next-turn');
        btn.disabled = true; btn.innerText = "â³ åå°æ¼”ç®—ä¸­...";

        try {
            const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
            const { data: room } = await supabaseClient.from('game_rooms').select('*').eq('id', currentRoomId).single();
            
            let sumP = 0, sumR = 0, coll = 0;
            for (let t of teams) {
                const d = t.last_decision || {p:0, r:0, s:0};
                if (t.authority > 0) {
                    sumP += d.p * (t.country_type==='B'?1.5:1);
                    sumR += d.r * (t.country_type==='A'?2:1);
                } else coll++;
                let nAuth = Math.max(0, Math.min(100, t.authority - (5 + d.p*1.2)*(t.country_type==='A'?1.3:1) + d.s*3));
                let bAP = (t.country_type==='A')?15:(t.country_type==='B'?12:8);
                await supabaseClient.from('teams').update({ authority: nAuth, last_decision: null, ap_count: bAP }).eq('id', t.id);
            }
            
            let nR0 = Math.max(0.5, room.infection_rate - (sumP/(teams.length*2.5)*0.1) + coll*0.05);
            let nInf = Math.floor(room.infection_total * nR0);
            let nCure = Math.min(100, room.cure_progress + (sumR/(teams.length*5)));
            
            await supabaseClient.from('game_rooms').update({ turn: room.turn+1, infection_total: nInf, infection_rate: nR0, cure_progress: nCure }).eq('id', currentRoomId);
            await supabaseClient.from('game_logs').insert([{ room_id: currentRoomId, exp_id: room.experiment_id, turn: room.turn, infection_total: nInf, infection_rate: nR0, cure_progress: nCure }]);
        } catch (e) {
            alert("ç½‘ç»œé”™è¯¯å¯¼è‡´ç»“ç®—å¤±è´¥ã€‚");
        } finally {
            btn.disabled = false; btn.innerText = "âš ï¸ ç»“ç®—æœ¬è½®å†³ç­–";
        }
    }

    // ================== å®æ—¶åˆ·æ–°æœºåˆ¶ ==================
    function subscribeToGame() {
        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
            if(payload.table === 'teams' && payload.new.room_id == currentRoomId) {
                if(myTeamId) { if(payload.new.id == myTeamId) updateStudentUI(payload.new); }
                else fetchTeamList(); // è‡ªåŠ¨åˆ·æ–°å³ä¾§æ 
            }
            if(payload.table === 'game_rooms' && payload.new.id == currentRoomId) {
                if(myTeamId) { 
                    alert("ğŸ”” æŒ‡æŒ¥ä¸­å¿ƒå·²ç»“ç®—ï¼ç¬¬ " + payload.new.turn + " è½®å¼€å§‹ï¼"); 
                    document.getElementById('s-status').innerText = ""; 
                    document.getElementById('btn-submit').disabled = false;
                    document.getElementById('in-p').value = 0; document.getElementById('in-r').value = 0; document.getElementById('in-s').value = 0;
                    calcAP();
                } else { 
                    updateTeacherStats(payload.new); fetchHistoryAndDraw(); 
                }
            }
        }).subscribe();
    }

    // ================== åŒå›¾è¡¨ä¸UIæ¸²æŸ“ ==================
    function initCharts() {
        // å›¾è¡¨ 1: æ„ŸæŸ“æ•° (æ²¡æœ‰ 100 çš„å°é¡¶é™åˆ¶)
        chartInf = new Chart(document.getElementById('chart-inf'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'æ„ŸæŸ“æ•°', data: [], borderColor: '#ff8a65', backgroundColor: 'rgba(255,138,101,0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
        // å›¾è¡¨ 2: è§£è¯è¿›åº¦ (0-100 å°é¡¶é™åˆ¶)
        chartCure = new Chart(document.getElementById('chart-cure'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'è§£è¯ %', data: [], borderColor: '#69f0ae', backgroundColor: 'rgba(105,240,174,0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{min:0, max:100}} }
        });
    }

    async function fetchHistoryAndDraw() {
        const { data: logs } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('turn');
        const { data: room } = await supabaseClient.from('game_rooms').select('experiment_id').eq('id', currentRoomId).single();
        const currentLogs = logs.filter(l => l.exp_id === room.experiment_id);
        
        if(chartInf && chartCure) {
            const labels = currentLogs.map(l => "R"+l.turn);
            chartInf.data.labels = labels;
            chartInf.data.datasets[0].data = currentLogs.map(l => l.infection_total);
            chartInf.update();

            chartCure.data.labels = labels;
            chartCure.data.datasets[0].data = currentLogs.map(l => l.cure_progress);
            chartCure.update();
        }
    }

    async function fetchTeamList() {
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).order('username');
        document.getElementById('t-online').innerText = teams.filter(t=>t.is_active).length;
        
        document.getElementById('team-list').innerHTML = teams.map(t => `
            <div class="team-compact ${t.authority<=0?'dead':''}" style="${!t.is_active?'opacity:0.4':''}">
                <div class="team-compact-header">
                    <strong style="font-size:14px; color:#1e293b;">${t.name} <span style="font-size:11px;color:#94a3b8;font-weight:normal;">(${t.username})</span></strong>
                    <span class="status-${t.country_type}">${t.country_type}</span>
                </div>
                <div class="team-compact-stats">
                    <span>âš¡ AP: <b style="color:#0f172a;">${t.ap_count}</b></span>
                    <span>ğŸ‘‘ æƒ: <b style="${t.authority<30?'color:#e74c3c':'color:#0f172a'};">${Math.floor(t.authority)}</b></span>
                    <span style="font-weight:bold;">${t.last_decision?'âœ… å·²å°±ç»ª':'â³ å†³ç­–ä¸­'}</span>
                </div>
            </div>`).join('');
    }

    function updateTeacherStats(r) {
        document.getElementById('t-exp').innerText = r.experiment_id;
        document.getElementById('t-turn').innerText = r.turn;
        document.getElementById('t-inf').innerText = r.infection_total.toLocaleString();
        document.getElementById('t-cure').innerText = r.cure_progress.toFixed(1) + '%';
    }

    function updateStudentUI(t) {
        myMaxAP = t.ap_count;
        document.getElementById('s-ap').innerText = t.ap_count;
        document.getElementById('s-max').innerText = t.ap_count;
        document.getElementById('s-auth').innerText = Math.floor(t.authority);
        document.getElementById('s-type-tag').innerText = t.country_type === 'å¾…å®š' ? "ç­‰å¾…æŒ‡æŒ¥åˆ†é…å±æ€§..." : "åˆ†é…å±æ€§: " + t.country_type + " å‹";
        document.getElementById('s-type-tag').className = "status-" + t.country_type;
    }

    // ================== å…¶ä½™åŠŸèƒ½å·¥å…· ==================
    async function exportCSV() {
        const { data: logs } = await supabaseClient.from('game_logs').select('*').eq('room_id', currentRoomId).order('created_at', { ascending: true });
        if(!logs.length) return alert("å½“å‰æˆ¿é—´æ— å®éªŒæ•°æ®ï¼");
        let csv = "\uFEFFå®éªŒåœºæ¬¡,è½®æ•°,æ„ŸæŸ“æ•°,R0,è§£è¯è¿›åº¦,è®°å½•æ—¶é—´\n";
        logs.forEach(l => csv += `${l.exp_id},${l.turn},${l.infection_total},${l.infection_rate},${l.cure_progress},${l.created_at}\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Dawn_Room${currentRoomId}.csv`; link.click();
    }

    function calcAP() {
        const p = parseInt(document.getElementById('in-p').value)||0, r = parseInt(document.getElementById('in-r').value)||0, s = parseInt(document.getElementById('in-s').value)||0;
        const total = p + r + s;
        document.getElementById('s-spent').innerText = total;
        document.getElementById('s-spent').style.color = total > myMaxAP ? 'red' : 'black';
        document.getElementById('btn-submit').disabled = total > myMaxAP;
    }

    async function submitDecision() {
        const p = parseInt(document.getElementById('in-p').value)||0, r = parseInt(document.getElementById('in-r').value)||0, s = parseInt(document.getElementById('in-s').value)||0;
        await supabaseClient.from('teams').update({ last_decision: {p, r, s} }).eq('id', myTeamId);
        document.getElementById('s-status').innerText = "âœ… é”å®š";
        document.getElementById('btn-submit').disabled = true;
    }

    async function assignRoles() {
        const { data: teams } = await supabaseClient.from('teams').select('*').eq('room_id', currentRoomId).eq('is_active', true);
        const p = ['A', 'B', 'B', 'C', 'C'];
        for (let i = 0; i < teams.length; i++) {
            let type = p[i % p.length], ap = (type==='A'?15:(type==='B'?12:8));
            await supabaseClient.from('teams').update({ country_type: type, ap_count: ap, authority: 100 }).eq('id', teams[i].id);
        }
        alert("åŠ¨æ€å±æ€§åˆ†é…å®Œæˆï¼");
    }

    async function updateTeamInfo() {
        const name = document.getElementById('edit-name').value, members = document.getElementById('edit-members').value;
        await supabaseClient.from('teams').update({ name, members }).eq('id', myTeamId);
        document.getElementById('s-team-display').innerText = name; alert("èµ„æ–™å·²ä¿å­˜ï¼");
    }
</script>
</body>
</html>
